<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alias Mapper Tool - Browser Only CSV Enhancer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .step {
            margin-bottom: 40px;
            padding: 30px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .step.active {
            border-color: #4facfe;
            background: #f8fbff;
        }

        .step.completed {
            border-color: #00c851;
            background: #f8fff9;
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e6ed;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .step.active .step-number {
            background: #4facfe;
            color: white;
        }

        .step.completed .step-number {
            background: #00c851;
            color: white;
        }

        .step-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
        }

        .step-description {
            margin-bottom: 20px;
            color: #666;
        }

        .input-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-btn {
            display: block;
            padding: 15px 25px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
        }

        .file-upload-btn:hover {
            background: #3d8bfe;
        }

        .sample-btn {
            padding: 15px 25px;
            background: #6c5ce7;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .sample-btn:hover {
            background: #5a4bd1;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #f1f3f4;
            border-radius: 4px;
            font-size: 0.9em;
            color: #666;
        }

        .column-selection {
            display: none;
            margin-top: 20px;
        }

        .column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .column-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            transition: all 0.2s ease;
        }

        .column-item:hover {
            background: #e9ecef;
        }

        .column-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .column-item label {
            cursor: pointer;
            flex: 1;
            font-weight: 500;
        }

        .suffix-input {
            margin: 20px 0;
        }

        .suffix-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .suffix-input input {
            width: 200px;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 1em;
        }

        .output-format-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .output-format-section h4 {
            margin-bottom: 12px;
            color: #333;
            font-size: 1.1em;
        }

        .format-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .format-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .format-option:hover {
            background: #e9ecef;
        }

        .format-option input[type="radio"] {
            margin-top: 3px;
            transform: scale(1.2);
        }

        .format-option-text {
            flex: 1;
        }

        .format-option-text strong {
            display: block;
            color: #333;
            margin-bottom: 2px;
        }

        .format-option-text span {
            font-size: 0.85em;
            color: #666;
        }

        .delimiter-input {
            display: none;
            margin-top: 10px;
            margin-left: 30px;
        }

        .delimiter-input label {
            font-size: 0.9em;
            color: #555;
            margin-right: 8px;
        }

        .delimiter-input input {
            width: 60px;
            padding: 6px 10px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 1em;
            text-align: center;
        }

        .btn {
            padding: 12px 25px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            background: #218838;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-primary {
            background: #4facfe;
        }

        .btn-primary:hover {
            background: #3d8bfe;
        }

        .progress {
            display: none;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: 600;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            text-align: center;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-buttons {
            margin-top: 20px;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .display-table-container {
            display: none;
            margin-top: 20px;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        .display-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .display-table th {
            background: #343a40;
            color: white;
            padding: 10px 12px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .display-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #dee2e6;
            white-space: nowrap;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .display-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .display-table tr:hover {
            background: #e9ecef;
        }

        .alias-match {
            background: #d4edda;
            font-weight: 500;
        }

        .node-edge-section {
            margin-top: 15px;
        }

        .node-edge-section h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1em;
        }

        .display-label {
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
            margin: 15px 0 5px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .column-grid {
                grid-template-columns: 1fr;
            }

            .input-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Alias Mapper Tool</h1>
            <p>Browser Only CSV Enhancer &mdash; Map alias columns onto your datasets entirely in your browser</p>
        </div>
        
        <div class="content">
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Load Alias Map</div>
                </div>
                <p class="step-description">
                    Upload a CSV with two columns: <strong>label</strong> (values to match) and <strong>alias</strong> (replacement values). An address may appear on multiple rows with different aliases.
                </p>
                <div class="input-options">
                    <div class="file-upload">
                        <input type="file" id="aliasMapFile" accept=".csv" data-testid="input-alias-map-file" />
                        <label for="aliasMapFile" class="file-upload-btn" data-testid="button-upload-alias-map">
                            Upload Alias Map CSV
                        </label>
                    </div>
                    <button class="sample-btn" id="sampleAliasBtn" onclick="loadSampleAliasMap()" data-testid="button-sample-alias-map">
                        Generate Sample Alias Map
                    </button>
                </div>
                <div class="file-info" id="aliasMapInfo" style="display: none;"></div>
            </div>

            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Load Target CSV</div>
                </div>
                <p class="step-description">
                    Upload the CSV file you want to enhance with alias columns, or generate a sample Tron transfer ledger.
                </p>
                <div class="input-options">
                    <div class="file-upload">
                        <input type="file" id="targetFile" accept=".csv" disabled data-testid="input-target-file" />
                        <label for="targetFile" class="file-upload-btn" data-testid="button-upload-target">
                            Upload Target CSV
                        </label>
                    </div>
                    <button class="sample-btn" id="sampleTargetBtn" onclick="loadSampleTargetCSV()" disabled data-testid="button-sample-target">
                        Generate Sample Transfers
                    </button>
                </div>
                <div class="file-info" id="targetFileInfo" style="display: none;"></div>
            </div>

            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Configure Alias Columns</div>
                </div>
                
                <div class="column-selection" id="columnSelection">
                    <p style="margin-bottom: 15px; color: #666;">
                        Select which columns should be scanned for aliases:
                    </p>
                    <div class="column-grid" id="columnGrid"></div>
                    
                    <div class="suffix-input">
                        <label for="aliasSuffix">Alias Column Suffix:</label>
                        <input type="text" id="aliasSuffix" value="_Alias" placeholder="_Alias" data-testid="input-alias-suffix" />
                    </div>

                    <div class="output-format-section">
                        <h4>Output Format</h4>
                        <div class="format-options">
                            <label class="format-option">
                                <input type="radio" name="outputFormat" value="delimiter" checked onchange="toggleDelimiterInput()" data-testid="radio-format-delimiter" />
                                <div class="format-option-text">
                                    <strong>Single Table &mdash; Custom Delimiter</strong>
                                    <span>Multiple aliases in one cell, separated by your chosen delimiter, wrapped in quotes</span>
                                </div>
                            </label>
                            <div class="delimiter-input" id="delimiterInput" style="display: block;">
                                <label for="delimiterChar">Delimiter:</label>
                                <input type="text" id="delimiterChar" value="|" maxlength="5" data-testid="input-delimiter" />
                            </div>

                            <label class="format-option">
                                <input type="radio" name="outputFormat" value="oneperrow" onchange="toggleDelimiterInput()" data-testid="radio-format-oneperrow" />
                                <div class="format-option-text">
                                    <strong>Single Table &mdash; One Row Per Alias</strong>
                                    <span>Transaction rows duplicated for each matching alias (useful for relational databases)</span>
                                </div>
                            </label>

                            <label class="format-option">
                                <input type="radio" name="outputFormat" value="nodeedge" onchange="toggleDelimiterInput()" data-testid="radio-format-nodeedge" />
                                <div class="format-option-text">
                                    <strong>Node/Edge Table</strong>
                                    <span>Separate Nodes and Edges CSVs for knowledge graph and link analysis tools</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn" id="processBtn" disabled onclick="processFiles()" data-testid="button-process">
                        Process Files
                    </button>
                </div>
            </div>

            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-title">Results</div>
                </div>
                
                <div class="progress" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Processing...</div>
                </div>
                
                <div id="resultContainer" style="display: none;">
                    <div class="success" id="resultMessage"></div>
                    <div class="result-actions">
                        <button class="btn" id="downloadBtn" onclick="downloadResult()" data-testid="button-download">
                            Download CSV
                        </button>
                        <button class="btn btn-primary" id="displayBtn" onclick="displayResult()" data-testid="button-display">
                            Display in Browser
                        </button>
                        <button class="btn btn-secondary" onclick="resetTool()" data-testid="button-reset">
                            Start Over
                        </button>
                    </div>
                    <div class="display-table-container" id="displayTableContainer" data-testid="display-table-container"></div>
                </div>
            </div>

            <div id="errorContainer"></div>
        </div>
    </div>

    <div id="overwriteModal" class="modal">
        <div class="modal-content">
            <h3>Column Already Exists</h3>
            <p id="overwriteMessage"></p>
            <div class="modal-buttons">
                <button class="btn" onclick="confirmOverwrite(true)">Yes, Overwrite</button>
                <button class="btn btn-secondary" onclick="confirmOverwrite(false)">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        var aliasMap = {};
        var targetData = [];
        var targetHeaders = [];
        var targetFileName = '';
        var processedResult = null;
        var overwriteCallback = null;

        document.getElementById('aliasMapFile').addEventListener('change', handleAliasMapUpload);
        document.getElementById('targetFile').addEventListener('change', handleTargetFileUpload);

        // ─── Sample Data: Tron Addresses ──────────────────────────────────

        var SAMPLE_ADDRESSES = {
            AARDVARK_AOI_001: 'TJYwDem1YQRjvsraPRJ3ELam2yFU6Fe29K',
            AARDVARK_AOI_002: 'TXo2vGtkzFPnAmGt3RLpqkANxTLCmf6uMF',
            AARDVARK_AOI_003: 'TVj7RNVHy6thbM7BWdSe9G6gXwKhjhdNZS',
            AARDVARK_CP_001:  'TN1qHhiqCLAfV6AHhBMXGdPX2ZRPGkFLpR',
            AARDVARK_CP_002:  'TPYmHEhy5n8TCEfYGqW2rPxsghSfzghPDn',
            AARDVARK_TT_001:  'TSfYBYgcuXS6RcMCRJjDeFGr2dXfkQBn5a',
            AARDVARK_TT_002:  'TLkFZzDensKjAiMQbcWMeVrOLAhLMUVPMb',

            BADGER_AOI_001:   'TG7jQ1PkM2qrzJEhMJYfBpNFy7sMUXdwNA',
            BADGER_AOI_002:   'TXo2vGtkzFPnAmGt3RLpqkANxTLCmf6uMF',
            BADGER_CP_001:    'THPvaUhoh2Qn2y9THCZML3H4PBatRNkFjE',
            BADGER_CP_002:    'TQHgMpVntrYt2R4WzXxYFgxAegnQNsHcrL',
            BADGER_TT_001:    'TStJqH1Ce3p6UQDQsAPk1cDBWi3HRJZP8B',

            CAPYBARA_AOI_001: 'TCkdu4rKYMtqr4YR12f38ZLXpgJaBCz6FF',
            CAPYBARA_AOI_002: 'TVj7RNVHy6thbM7BWdSe9G6gXwKhjhdNZS',
            CAPYBARA_CP_001:  'TFQ3Y4NyhwSdYB5NjLXhUqMczg2WHhAFRa',
            CAPYBARA_TT_001:  'TRgEJh5p38ytFmvMdJnHLr4sqPGgj2xKuV',

            EXCHANGE_A:       'TKwMR6N3dMcnhN3fRRGL5oKNzaBy4HPHZF',
            EXCHANGE_B:       'TNaRAoLUyYEV2uF7GUrzSjRQTU8v5ZJ5VR',
            NEUTRAL_001:      'TDqSquXBgUCLYvYC4XZgrprLK589WkhKza',
            NEUTRAL_002:      'TFMXUMQx8GeNUjgSEWF2v2dD5fVj6Cha3R',
            NEUTRAL_003:      'TMHmfWs1WQ88bSfrMgpVRsBKmJ3xoJBfea',
        };

        var SAMPLE_TX_HASHES = {
            TX_AARDVARK_01: 'a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2',
            TX_AARDVARK_02: 'b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3',
            TX_AARDVARK_03: 'c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4',
            TX_BADGER_01:   'd4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5',
            TX_BADGER_02:   'e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6',
            TX_CAPYBARA_01: 'f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7',
            TX_CAPYBARA_02: 'a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8',
            TX_NEUTRAL_01:  'b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9',
            TX_NEUTRAL_02:  'c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0',
            TX_NEUTRAL_03:  'd0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1',
            TX_NEUTRAL_04:  'e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2',
            TX_NEUTRAL_05:  'f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6a7b8c9d0e1f2a3',
        };

        // ─── Sample Alias Map Generator ───────────────────────────────────

        function generateSampleAliasMap() {
            var entries = [
                { label: SAMPLE_ADDRESSES.AARDVARK_AOI_001, alias: 'AARDVARK AoI-001' },
                { label: SAMPLE_ADDRESSES.AARDVARK_AOI_002, alias: 'AARDVARK AoI-002' },
                { label: SAMPLE_ADDRESSES.AARDVARK_AOI_003, alias: 'AARDVARK AoI-003' },
                { label: SAMPLE_ADDRESSES.AARDVARK_CP_001,  alias: 'AARDVARK Counterparty' },
                { label: SAMPLE_ADDRESSES.AARDVARK_CP_002,  alias: 'AARDVARK Counterparty' },
                { label: SAMPLE_ADDRESSES.AARDVARK_TT_001,  alias: 'AARDVARK Txn Trace' },
                { label: SAMPLE_ADDRESSES.AARDVARK_TT_002,  alias: 'AARDVARK Txn Trace' },
                { label: SAMPLE_TX_HASHES.TX_AARDVARK_01,   alias: 'AARDVARK Txn Trace' },
                { label: SAMPLE_TX_HASHES.TX_AARDVARK_02,   alias: 'AARDVARK Txn Trace' },
                { label: SAMPLE_TX_HASHES.TX_AARDVARK_03,   alias: 'AARDVARK Txn Trace' },

                { label: SAMPLE_ADDRESSES.BADGER_AOI_001,   alias: 'BADGER AoI-001' },
                { label: SAMPLE_ADDRESSES.BADGER_AOI_002,   alias: 'BADGER AoI-002' },
                { label: SAMPLE_ADDRESSES.BADGER_CP_001,    alias: 'BADGER Counterparty' },
                { label: SAMPLE_ADDRESSES.BADGER_CP_002,    alias: 'BADGER Counterparty' },
                { label: SAMPLE_ADDRESSES.BADGER_TT_001,    alias: 'BADGER Txn Trace' },
                { label: SAMPLE_TX_HASHES.TX_BADGER_01,     alias: 'BADGER Txn Trace' },
                { label: SAMPLE_TX_HASHES.TX_BADGER_02,     alias: 'BADGER Txn Trace' },

                { label: SAMPLE_ADDRESSES.CAPYBARA_AOI_001, alias: 'CAPYBARA AoI-001' },
                { label: SAMPLE_ADDRESSES.CAPYBARA_AOI_002, alias: 'CAPYBARA AoI-002' },
                { label: SAMPLE_ADDRESSES.CAPYBARA_CP_001,  alias: 'CAPYBARA Counterparty' },
                { label: SAMPLE_ADDRESSES.CAPYBARA_TT_001,  alias: 'CAPYBARA Txn Trace' },
                { label: SAMPLE_TX_HASHES.TX_CAPYBARA_01,   alias: 'CAPYBARA Txn Trace' },
                { label: SAMPLE_TX_HASHES.TX_CAPYBARA_02,   alias: 'CAPYBARA Txn Trace' },

                { label: SAMPLE_ADDRESSES.EXCHANGE_A,       alias: 'Exchange A (Binance)' },
                { label: SAMPLE_ADDRESSES.EXCHANGE_B,       alias: 'Exchange B (OKX)' },
            ];
            return entries;
        }

        // ─── Sample Target CSV Generator ──────────────────────────────────

        function generateSampleTargetCSV() {
            var baseDate = new Date('2025-11-15T08:00:00Z');
            var transfers = [];

            function addTransfer(dayOffset, hourOffset, from, to, txHash, asset, amount, usdValue) {
                var d = new Date(baseDate.getTime() + (dayOffset * 86400000) + (hourOffset * 3600000));
                var dateStr = d.toISOString().replace('T', ' ').substring(0, 19);
                transfers.push({
                    'Date_Time': dateStr,
                    'Chain': 'TRX',
                    'From': from,
                    'To': to,
                    'Txn_Hash': txHash,
                    'Asset': asset,
                    'Asset_Amnt': amount,
                    'USD_Value': usdValue
                });
            }

            var A = SAMPLE_ADDRESSES;
            var TX = SAMPLE_TX_HASHES;

            addTransfer(0, 0, A.AARDVARK_AOI_001, A.AARDVARK_CP_001, TX.TX_AARDVARK_01, 'USDT', '25000.00', '25000.00');
            addTransfer(0, 2, A.AARDVARK_CP_001,  A.AARDVARK_AOI_002, TX.TX_AARDVARK_02, 'USDT', '24800.00', '24800.00');
            addTransfer(0, 5, A.AARDVARK_AOI_002, A.EXCHANGE_A,       TX.TX_AARDVARK_03, 'USDT', '24500.00', '24500.00');

            addTransfer(1, 1, A.AARDVARK_TT_001,  A.AARDVARK_AOI_003, TX.TX_NEUTRAL_01, 'TRX', '150000.00', '12750.00');
            addTransfer(1, 3, A.AARDVARK_AOI_003,  A.AARDVARK_TT_002, TX.TX_NEUTRAL_02, 'USDT', '8500.00', '8500.00');

            addTransfer(2, 0, A.BADGER_AOI_001,   A.BADGER_CP_001,    TX.TX_BADGER_01, 'USDT', '100000.00', '100000.00');
            addTransfer(2, 1, A.BADGER_CP_001,    A.BADGER_AOI_002,   TX.TX_BADGER_02, 'USDT', '95000.00', '95000.00');
            addTransfer(2, 4, A.BADGER_AOI_002,   A.EXCHANGE_B,       TX.TX_NEUTRAL_03, 'USDT', '94000.00', '94000.00');

            addTransfer(3, 0, A.BADGER_TT_001,    A.BADGER_CP_002,    TX.TX_NEUTRAL_04, 'TRX', '500000.00', '42500.00');

            addTransfer(4, 2, A.CAPYBARA_AOI_001, A.CAPYBARA_CP_001,  TX.TX_CAPYBARA_01, 'USDT', '50000.00', '50000.00');
            addTransfer(4, 5, A.CAPYBARA_CP_001,  A.CAPYBARA_AOI_002, TX.TX_CAPYBARA_02, 'USDT', '49500.00', '49500.00');
            addTransfer(4, 8, A.CAPYBARA_AOI_002, A.EXCHANGE_A,       TX.TX_NEUTRAL_05, 'USDT', '49000.00', '49000.00');

            addTransfer(5, 0, A.CAPYBARA_TT_001,  A.CAPYBARA_AOI_001, TX.TX_NEUTRAL_01, 'TRX', '200000.00', '17000.00');

            addTransfer(0, 6, A.NEUTRAL_001, A.NEUTRAL_002, TX.TX_NEUTRAL_01, 'TRX', '1000.00', '85.00');
            addTransfer(1, 7, A.NEUTRAL_002, A.NEUTRAL_003, TX.TX_NEUTRAL_02, 'USDT', '500.00', '500.00');
            addTransfer(3, 2, A.NEUTRAL_003, A.NEUTRAL_001, TX.TX_NEUTRAL_03, 'USDT', '250.00', '250.00');
            addTransfer(5, 3, A.EXCHANGE_A,  A.NEUTRAL_001, TX.TX_NEUTRAL_04, 'TRX', '5000.00', '425.00');
            addTransfer(6, 1, A.NEUTRAL_001, A.EXCHANGE_B,  TX.TX_NEUTRAL_05, 'USDT', '1200.00', '1200.00');

            addTransfer(1, 0, A.AARDVARK_CP_002, A.BADGER_CP_002,   TX.TX_NEUTRAL_01, 'USDT', '15000.00', '15000.00');
            addTransfer(3, 6, A.BADGER_AOI_001,  A.CAPYBARA_CP_001, TX.TX_NEUTRAL_02, 'USDT', '30000.00', '30000.00');

            return transfers;
        }

        // ─── Load Sample Data ─────────────────────────────────────────────

        function loadSampleAliasMap() {
            var entries = generateSampleAliasMap();

            aliasMap = {};
            entries.forEach(function(entry) {
                var key = entry.label.toLowerCase();
                if (!aliasMap[key]) {
                    aliasMap[key] = [];
                }
                aliasMap[key].push(entry.alias);
            });

            var totalMappings = entries.length;
            var uniqueLabels = Object.keys(aliasMap).length;
            var multiAlias = Object.values(aliasMap).filter(function(v) { return v.length > 1; }).length;

            document.getElementById('aliasMapInfo').innerHTML =
                'Loaded ' + totalMappings + ' alias mappings (' + uniqueLabels + ' unique labels, ' + multiAlias + ' with multiple aliases) from sample data (AARDVARK, BADGER, CAPYBARA)';
            document.getElementById('aliasMapInfo').style.display = 'block';

            document.getElementById('step1').classList.add('completed');
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            document.getElementById('targetFile').disabled = false;
            document.getElementById('sampleTargetBtn').disabled = false;

            showSuccess('Sample alias map loaded: 3 investigations with AoI, Counterparty, and Txn Trace classifications');
        }

        function loadSampleTargetCSV() {
            var transfers = generateSampleTargetCSV();

            targetHeaders = ['Date_Time', 'Chain', 'From', 'To', 'Txn_Hash', 'Asset', 'Asset_Amnt', 'USD_Value'];
            targetData = transfers;
            targetFileName = 'sample-tron-transfers';

            document.getElementById('targetFileInfo').innerHTML =
                'Loaded ' + targetData.length + ' rows with ' + targetHeaders.length + ' columns from sample Tron transfer data';
            document.getElementById('targetFileInfo').style.display = 'block';

            displayColumnSelection();

            document.getElementById('step2').classList.add('completed');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');

            showSuccess('Sample target CSV loaded: Tron TRX/USDT transfers across multiple investigations');
        }

        // ─── UI Helpers ───────────────────────────────────────────────────

        function showError(message) {
            var errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = '<div class="error">' + message + '</div>';
            setTimeout(function() {
                errorContainer.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            var errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = '<div class="success">' + message + '</div>';
            setTimeout(function() {
                errorContainer.innerHTML = '';
            }, 4000);
        }

        function toggleDelimiterInput() {
            var format = document.querySelector('input[name="outputFormat"]:checked').value;
            document.getElementById('delimiterInput').style.display = (format === 'delimiter') ? 'block' : 'none';
        }

        // ─── CSV Parsing ──────────────────────────────────────────────────

        function parseCSV(csvText) {
            var lines = csvText.split('\n');
            var result = [];
            var headers = [];

            if (lines.length === 0) {
                throw new Error('CSV file is empty');
            }

            headers = parseCSVLine(lines[0]);
            
            for (var i = 1; i < lines.length; i++) {
                var line = lines[i].trim();
                if (line) {
                    var row = parseCSVLine(line);
                    if (row.length === headers.length) {
                        var rowObj = {};
                        headers.forEach(function(header, index) {
                            rowObj[header] = row[index] || '';
                        });
                        result.push(rowObj);
                    }
                }
            }

            return { headers: headers, data: result };
        }

        function parseCSVLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;
            
            for (var i = 0; i < line.length; i++) {
                var ch = line[i];
                var nextChar = line[i + 1];
                
                if (ch === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (ch === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += ch;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        function csvEscape(value) {
            if (value == null) return '';
            var str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('|') || str.includes(';')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        // ─── File Upload Handlers ─────────────────────────────────────────

        function handleAliasMapUpload(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var csvData = parseCSV(e.target.result);
                    
                    var requiredColumns = ['label', 'alias'];
                    var missingColumns = requiredColumns.filter(function(col) {
                        return !csvData.headers.some(function(header) { return header.toLowerCase() === col; });
                    });
                    
                    if (missingColumns.length > 0) {
                        throw new Error('Missing required columns: ' + missingColumns.join(', ') + '. Expected columns: label, alias');
                    }

                    aliasMap = {};
                    var labelCol = csvData.headers.find(function(h) { return h.toLowerCase() === 'label'; });
                    var aliasCol = csvData.headers.find(function(h) { return h.toLowerCase() === 'alias'; });
                    
                    csvData.data.forEach(function(row) {
                        var label = row[labelCol];
                        var alias = row[aliasCol];
                        if (label && alias) {
                            var key = label.toLowerCase();
                            if (!aliasMap[key]) {
                                aliasMap[key] = [];
                            }
                            aliasMap[key].push(alias);
                        }
                    });

                    var uniqueLabels = Object.keys(aliasMap).length;
                    var totalMappings = csvData.data.length;
                    var multiAlias = Object.values(aliasMap).filter(function(v) { return v.length > 1; }).length;

                    document.getElementById('aliasMapInfo').innerHTML =
                        'Loaded ' + totalMappings + ' alias mappings (' + uniqueLabels + ' unique labels, ' + multiAlias + ' with multiple aliases) from "' + file.name + '"';
                    document.getElementById('aliasMapInfo').style.display = 'block';
                    
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('step1').classList.remove('active');
                    document.getElementById('step2').classList.add('active');
                    document.getElementById('targetFile').disabled = false;
                    document.getElementById('sampleTargetBtn').disabled = false;
                    
                    showSuccess('Alias map loaded successfully!');
                } catch (error) {
                    showError('Error parsing alias map: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function handleTargetFileUpload(event) {
            var file = event.target.files[0];
            if (!file) return;

            targetFileName = file.name.replace('.csv', '');
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var csvData = parseCSV(e.target.result);
                    targetHeaders = csvData.headers;
                    targetData = csvData.data;

                    document.getElementById('targetFileInfo').innerHTML =
                        'Loaded ' + targetData.length + ' rows with ' + targetHeaders.length + ' columns from "' + file.name + '"';
                    document.getElementById('targetFileInfo').style.display = 'block';
                    
                    displayColumnSelection();
                    
                    document.getElementById('step2').classList.add('completed');
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step3').classList.add('active');
                    
                    showSuccess('Target CSV loaded successfully!');
                } catch (error) {
                    showError('Error parsing target CSV: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // ─── Column Selection ─────────────────────────────────────────────

        function displayColumnSelection() {
            var columnGrid = document.getElementById('columnGrid');
            columnGrid.innerHTML = '';
            
            targetHeaders.forEach(function(header) {
                var div = document.createElement('div');
                div.className = 'column-item';
                div.innerHTML =
                    '<input type="checkbox" id="col_' + header + '" value="' + header + '" onchange="updateProcessButton()" data-testid="checkbox-col-' + header + '">' +
                    '<label for="col_' + header + '">' + header + '</label>';
                columnGrid.appendChild(div);
            });
            
            document.getElementById('columnSelection').style.display = 'block';
        }

        function updateProcessButton() {
            var checkboxes = document.querySelectorAll('#columnGrid input[type="checkbox"]');
            var anyChecked = Array.from(checkboxes).some(function(cb) { return cb.checked; });
            document.getElementById('processBtn').disabled = !anyChecked;
        }

        function getSelectedColumns() {
            var checkboxes = document.querySelectorAll('#columnGrid input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(function(cb) { return cb.value; });
        }

        // ─── Processing ──────────────────────────────────────────────────

        function checkExistingColumns(selectedColumns, suffix) {
            var existing = [];
            selectedColumns.forEach(function(col) {
                var aliasColumnName = col + suffix;
                if (targetHeaders.includes(aliasColumnName)) {
                    existing.push(aliasColumnName);
                }
            });
            return existing;
        }

        function showOverwriteModal(existingColumns, callback) {
            var modal = document.getElementById('overwriteModal');
            var message = document.getElementById('overwriteMessage');
            message.textContent = 'The following alias columns already exist: ' + existingColumns.join(', ') + '. Do you want to overwrite them?';
            modal.style.display = 'block';
            overwriteCallback = callback;
        }

        function confirmOverwrite(overwrite) {
            document.getElementById('overwriteModal').style.display = 'none';
            if (overwriteCallback) {
                overwriteCallback(overwrite);
                overwriteCallback = null;
            }
        }

        function processFiles() {
            var selectedColumns = getSelectedColumns();
            var suffix = document.getElementById('aliasSuffix').value || '_Alias';
            
            if (selectedColumns.length === 0) {
                showError('Please select at least one column to process');
                return;
            }

            var format = document.querySelector('input[name="outputFormat"]:checked').value;

            if (format !== 'nodeedge') {
                var existingColumns = checkExistingColumns(selectedColumns, suffix);
                if (existingColumns.length > 0) {
                    showOverwriteModal(existingColumns, function(overwrite) {
                        if (overwrite) {
                            performProcessing(selectedColumns, suffix, format);
                        }
                    });
                    return;
                }
            }

            performProcessing(selectedColumns, suffix, format);
        }

        function performProcessing(selectedColumns, suffix, format) {
            document.getElementById('step3').classList.add('completed');
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step4').classList.add('active');
            
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('displayTableContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'none';
            
            setTimeout(function() {
                if (format === 'nodeedge') {
                    processNodeEdge(selectedColumns, suffix);
                } else if (format === 'oneperrow') {
                    processOnePerRow(selectedColumns, suffix);
                } else {
                    processDelimited(selectedColumns, suffix);
                }
            }, 100);
        }

        // ─── Format: Custom Delimiter ─────────────────────────────────────

        function processDelimited(selectedColumns, suffix) {
            var delimiter = document.getElementById('delimiterChar').value || '|';
            var progressFill = document.getElementById('progressFill');
            var progressText = document.getElementById('progressText');

            var newHeaders = targetHeaders.slice();
            var aliasColumnPositions = {};

            selectedColumns.forEach(function(col) {
                var aliasColumnName = col + suffix;
                var existingIdx = newHeaders.indexOf(aliasColumnName);
                if (existingIdx !== -1) {
                    newHeaders.splice(existingIdx, 1);
                }
                var insertIndex = newHeaders.indexOf(col) + 1;
                newHeaders.splice(insertIndex, 0, aliasColumnName);
                aliasColumnPositions[col] = aliasColumnName;
            });

            var rows = [];
            var totalMatches = 0;

            for (var i = 0; i < targetData.length; i++) {
                var row = targetData[i];
                var newRow = {};

                newHeaders.forEach(function(header) {
                    if (targetHeaders.includes(header)) {
                        newRow[header] = row[header] || '';
                    } else {
                        newRow[header] = '';
                    }
                });

                selectedColumns.forEach(function(col) {
                    var aliasColumnName = aliasColumnPositions[col];
                    var cellValue = row[col];
                    if (cellValue) {
                        var aliases = aliasMap[cellValue.toLowerCase()];
                        if (aliases && aliases.length > 0) {
                            newRow[aliasColumnName] = aliases.join(delimiter);
                            totalMatches++;
                        }
                    }
                });

                rows.push(newRow);

                if (i % 100 === 0) {
                    var pct = ((i / targetData.length) * 100).toFixed(0);
                    progressFill.style.width = pct + '%';
                    progressText.textContent = 'Processing row ' + i + ' of ' + targetData.length + '...';
                }
            }

            processedResult = {
                type: 'flat',
                headers: newHeaders,
                rows: rows,
                totalMatches: totalMatches,
                selectedColumns: selectedColumns,
                suffix: suffix
            };

            finishProcessing(totalMatches, selectedColumns.length);
        }

        // ─── Format: One Row Per Alias ────────────────────────────────────

        function processOnePerRow(selectedColumns, suffix) {
            var progressFill = document.getElementById('progressFill');
            var progressText = document.getElementById('progressText');

            var newHeaders = targetHeaders.slice();
            var aliasColumnPositions = {};

            selectedColumns.forEach(function(col) {
                var aliasColumnName = col + suffix;
                var existingIdx = newHeaders.indexOf(aliasColumnName);
                if (existingIdx !== -1) {
                    newHeaders.splice(existingIdx, 1);
                }
                var insertIndex = newHeaders.indexOf(col) + 1;
                newHeaders.splice(insertIndex, 0, aliasColumnName);
                aliasColumnPositions[col] = aliasColumnName;
            });

            var rows = [];
            var totalMatches = 0;

            for (var i = 0; i < targetData.length; i++) {
                var row = targetData[i];

                var allAliasArrays = [];
                var colNames = [];
                selectedColumns.forEach(function(col) {
                    var cellValue = row[col];
                    var aliases = (cellValue && aliasMap[cellValue.toLowerCase()]) ? aliasMap[cellValue.toLowerCase()] : [null];
                    allAliasArrays.push(aliases);
                    colNames.push(col);
                });

                var combinations = cartesianProduct(allAliasArrays);

                combinations.forEach(function(combo) {
                    var newRow = {};
                    newHeaders.forEach(function(header) {
                        if (targetHeaders.includes(header)) {
                            newRow[header] = row[header] || '';
                        } else {
                            newRow[header] = '';
                        }
                    });

                    combo.forEach(function(aliasValue, idx) {
                        var aliasColumnName = aliasColumnPositions[colNames[idx]];
                        if (aliasValue) {
                            newRow[aliasColumnName] = aliasValue;
                            totalMatches++;
                        }
                    });

                    rows.push(newRow);
                });

                if (i % 100 === 0) {
                    var pct = ((i / targetData.length) * 100).toFixed(0);
                    progressFill.style.width = pct + '%';
                    progressText.textContent = 'Processing row ' + i + ' of ' + targetData.length + '...';
                }
            }

            processedResult = {
                type: 'flat',
                headers: newHeaders,
                rows: rows,
                totalMatches: totalMatches,
                selectedColumns: selectedColumns,
                suffix: suffix
            };

            finishProcessing(totalMatches, selectedColumns.length);
        }

        function cartesianProduct(arrays) {
            if (arrays.length === 0) return [[]];
            return arrays.reduce(function(acc, curr) {
                var result = [];
                acc.forEach(function(a) {
                    curr.forEach(function(b) {
                        result.push(a.concat([b]));
                    });
                });
                return result;
            }, [[]]);
        }

        // ─── Format: Node/Edge ────────────────────────────────────────────

        function processNodeEdge(selectedColumns, suffix) {
            var progressFill = document.getElementById('progressFill');
            var progressText = document.getElementById('progressText');

            var nodeMap = {};
            var nodeIdCounter = 1;
            var edges = [];

            function getOrCreateNode(value) {
                if (!value) return null;
                var key = value.toLowerCase();
                if (!nodeMap[key]) {
                    var aliases = aliasMap[key] || [];
                    nodeMap[key] = {
                        NodeID: nodeIdCounter++,
                        Label: value,
                        Aliases: aliases.join(' | ')
                    };
                }
                return nodeMap[key];
            }

            var fromCol = null;
            var toCol = null;
            selectedColumns.forEach(function(col) {
                var lower = col.toLowerCase();
                if (lower === 'from') fromCol = col;
                if (lower === 'to') toCol = col;
            });

            for (var i = 0; i < targetData.length; i++) {
                var row = targetData[i];

                selectedColumns.forEach(function(col) {
                    var val = row[col];
                    if (val) getOrCreateNode(val);
                });

                if (fromCol && toCol && row[fromCol] && row[toCol]) {
                    var sourceNode = getOrCreateNode(row[fromCol]);
                    var targetNode = getOrCreateNode(row[toCol]);

                    var edge = {
                        SourceNodeID: sourceNode.NodeID,
                        TargetNodeID: targetNode.NodeID,
                        Source: row[fromCol],
                        Target: row[toCol]
                    };

                    targetHeaders.forEach(function(h) {
                        if (h !== fromCol && h !== toCol) {
                            edge[h] = row[h] || '';
                        }
                    });

                    edges.push(edge);
                } else {
                    selectedColumns.forEach(function(col, idx) {
                        if (idx < selectedColumns.length - 1) {
                            var val1 = row[selectedColumns[idx]];
                            var val2 = row[selectedColumns[idx + 1]];
                            if (val1 && val2) {
                                var s = getOrCreateNode(val1);
                                var t = getOrCreateNode(val2);
                                var e = {
                                    SourceNodeID: s.NodeID,
                                    TargetNodeID: t.NodeID,
                                    Source: val1,
                                    Target: val2
                                };
                                targetHeaders.forEach(function(h) {
                                    if (selectedColumns.indexOf(h) === -1) {
                                        e[h] = row[h] || '';
                                    }
                                });
                                edges.push(e);
                            }
                        }
                    });
                }

                if (i % 100 === 0) {
                    var pct = ((i / targetData.length) * 100).toFixed(0);
                    progressFill.style.width = pct + '%';
                    progressText.textContent = 'Processing row ' + i + ' of ' + targetData.length + '...';
                }
            }

            var nodes = Object.values(nodeMap);
            var nodeHeaders = ['NodeID', 'Label', 'Aliases'];
            var edgeHeaders = ['SourceNodeID', 'TargetNodeID', 'Source', 'Target'];
            targetHeaders.forEach(function(h) {
                if ((fromCol && h === fromCol) || (toCol && h === toCol)) return;
                if (selectedColumns.indexOf(h) !== -1 && h !== fromCol && h !== toCol) return;
                edgeHeaders.push(h);
            });

            var matchedNodes = nodes.filter(function(n) { return n.Aliases !== ''; }).length;

            processedResult = {
                type: 'nodeedge',
                nodeHeaders: nodeHeaders,
                nodes: nodes,
                edgeHeaders: edgeHeaders,
                edges: edges,
                totalMatches: matchedNodes
            };

            finishProcessing(matchedNodes, selectedColumns.length);
        }

        // ─── Finish & Output ──────────────────────────────────────────────

        function finishProcessing(totalMatches, colCount) {
            document.getElementById('progressContainer').style.display = 'none';
            
            var msg = 'Processing complete. Found ' + totalMatches + ' matches across ' + colCount + ' column(s).';
            if (processedResult.type === 'flat') {
                msg += ' Output has ' + processedResult.rows.length + ' rows.';
            } else {
                msg += ' ' + processedResult.nodes.length + ' nodes and ' + processedResult.edges.length + ' edges generated.';
            }

            document.getElementById('resultMessage').textContent = msg;
            document.getElementById('resultContainer').style.display = 'block';
            showSuccess('Files processed successfully!');
        }

        // ─── Download ─────────────────────────────────────────────────────

        function downloadResult() {
            if (!processedResult) {
                showError('No processed data to download');
                return;
            }

            if (processedResult.type === 'flat') {
                var csvContent = processedResult.headers.map(csvEscape).join(',') + '\n';
                processedResult.rows.forEach(function(row) {
                    var line = processedResult.headers.map(function(h) { return csvEscape(row[h] || ''); });
                    csvContent += line.join(',') + '\n';
                });
                downloadFile(csvContent, 'with-alias-' + targetFileName + '.csv');
            } else {
                var nodeCSV = processedResult.nodeHeaders.map(csvEscape).join(',') + '\n';
                processedResult.nodes.forEach(function(node) {
                    var line = processedResult.nodeHeaders.map(function(h) { return csvEscape(node[h] || ''); });
                    nodeCSV += line.join(',') + '\n';
                });

                var edgeCSV = processedResult.edgeHeaders.map(csvEscape).join(',') + '\n';
                processedResult.edges.forEach(function(edge) {
                    var line = processedResult.edgeHeaders.map(function(h) { return csvEscape(edge[h] || ''); });
                    edgeCSV += line.join(',') + '\n';
                });

                downloadFile(nodeCSV, targetFileName + '-nodes.csv');
                setTimeout(function() {
                    downloadFile(edgeCSV, targetFileName + '-edges.csv');
                }, 500);
            }
        }

        function downloadFile(content, filename) {
            var blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            if (link.download !== undefined) {
                var url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showSuccess('Downloaded: ' + filename);
            } else {
                showError('Download not supported in this browser');
            }
        }

        // ─── Display In Browser ───────────────────────────────────────────

        function displayResult() {
            if (!processedResult) {
                showError('No processed data to display');
                return;
            }

            var container = document.getElementById('displayTableContainer');
            container.innerHTML = '';

            if (processedResult.type === 'flat') {
                container.appendChild(buildTable(processedResult.headers, processedResult.rows, processedResult.selectedColumns, processedResult.suffix));
            } else {
                var nodeLabel = document.createElement('div');
                nodeLabel.className = 'display-label';
                nodeLabel.textContent = 'Nodes (' + processedResult.nodes.length + ')';
                container.appendChild(nodeLabel);
                container.appendChild(buildTable(processedResult.nodeHeaders, processedResult.nodes, [], ''));

                var edgeLabel = document.createElement('div');
                edgeLabel.className = 'display-label';
                edgeLabel.style.marginTop = '20px';
                edgeLabel.textContent = 'Edges (' + processedResult.edges.length + ')';
                container.appendChild(edgeLabel);
                container.appendChild(buildTable(processedResult.edgeHeaders, processedResult.edges, [], ''));
            }

            container.style.display = 'block';
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function buildTable(headers, rows, aliasSelectedCols, suffix) {
            var table = document.createElement('table');
            table.className = 'display-table';

            var aliasColNames = {};
            if (aliasSelectedCols && suffix) {
                aliasSelectedCols.forEach(function(col) {
                    aliasColNames[col + suffix] = true;
                });
            }

            var thead = document.createElement('thead');
            var headerRow = document.createElement('tr');
            headers.forEach(function(h) {
                var th = document.createElement('th');
                th.textContent = h;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            var tbody = document.createElement('tbody');
            var displayRows = rows.slice(0, 500);
            displayRows.forEach(function(row) {
                var tr = document.createElement('tr');
                headers.forEach(function(h) {
                    var td = document.createElement('td');
                    var val = row[h] || '';
                    td.textContent = val;
                    td.title = val;
                    if (aliasColNames[h] && val) {
                        td.className = 'alias-match';
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            var wrapper = document.createElement('div');
            wrapper.style.overflowX = 'auto';
            wrapper.appendChild(table);

            if (rows.length > 500) {
                var notice = document.createElement('p');
                notice.style.padding = '10px';
                notice.style.color = '#666';
                notice.style.fontSize = '0.85em';
                notice.textContent = 'Showing first 500 of ' + rows.length + ' rows. Download for complete data.';
                wrapper.appendChild(notice);
            }

            return wrapper;
        }

        // ─── Reset ────────────────────────────────────────────────────────

        function resetTool() {
            aliasMap = {};
            targetData = [];
            targetHeaders = [];
            targetFileName = '';
            processedResult = null;
            
            document.getElementById('aliasMapFile').value = '';
            document.getElementById('targetFile').value = '';
            document.getElementById('targetFile').disabled = true;
            document.getElementById('sampleTargetBtn').disabled = true;
            
            document.getElementById('aliasMapInfo').style.display = 'none';
            document.getElementById('targetFileInfo').style.display = 'none';
            document.getElementById('columnSelection').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('displayTableContainer').style.display = 'none';
            document.getElementById('errorContainer').innerHTML = '';
            
            document.querySelectorAll('.step').forEach(function(step) {
                step.classList.remove('active', 'completed');
            });
            document.getElementById('step1').classList.add('active');
            
            document.getElementById('aliasSuffix').value = '_Alias';
            document.getElementById('delimiterChar').value = '|';
            document.getElementById('processBtn').disabled = true;

            var delimiterRadio = document.querySelector('input[name="outputFormat"][value="delimiter"]');
            if (delimiterRadio) delimiterRadio.checked = true;
            toggleDelimiterInput();
        }

        window.onclick = function(event) {
            var modal = document.getElementById('overwriteModal');
            if (event.target === modal) {
                modal.style.display = 'none';
                overwriteCallback = null;
            }
        };
    </script>
</body>
</html>
